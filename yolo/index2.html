<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YOLO Object Detection</title>
  <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7.22.10/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useRef } = React;

    function App() {
      const [image, setImage] = useState(null);
      const [result, setResult] = useState(null);
      const [loading, setLoading] = useState(false);
      const canvasRef = useRef(null);

      // Handle file upload
      const handleFileChange = (e) => {
        const file = e.target.files[0];
        if (file) {
          setImage(file);
          setResult(null); // Reset previous result
        }
      };

      // Handle form submission
      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!image) {
          alert('Please select an image first!');
          return;
        }

        setLoading(true);
        const formData = new FormData();
        formData.append('image', image);

        try {
          // Replace with your actual backend endpoint
          const response = await fetch('/detect', {
            method: 'POST',
            body: formData,
          });

          // Mock response for demo (uncomment to test without backend)
          /*
          const mockResponse = {
            image: await convertImageToBase64(image),
            objects: [
              { class: 'car', confidence: 0.95, box: [100, 100, 200, 150] },
              { class: 'person', confidence: 0.89, box: [300, 200, 100, 200] },
              { class: 'dog', confidence: 0.92, box: [50, 300, 150, 100] },
            ],
          };
          const responseData = mockResponse;
          */

          const responseData = await response.json();
          setResult(responseData);

          // Draw bounding boxes on canvas
          if (canvasRef.current && responseData.objects) {
            const ctx = canvasRef.current.getContext('2d');
            const img = new Image();
            img.src = `data:image/jpeg;base64,${responseData.image}`;
            img.onload = () => {
              canvasRef.current.width = img.width;
              canvasRef.current.height = img.height;
              ctx.drawImage(img, 0, 0);
              responseData.objects.forEach((obj, index) => {
                const [x, y, width, height] = obj.box;
                ctx.strokeStyle = ['red', 'blue', 'green'][index % 3]; // Different colors for each box
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, width, height);
                ctx.fillStyle = ctx.strokeStyle;
                ctx.font = '16px Arial';
                ctx.fillText(`${obj.class} (${(obj.confidence * 100).toFixed(2)}%)`, x, y - 10);
              });
            };
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Failed to process image.');
        } finally {
          setLoading(false);
        }
      };

      // Helper function to convert image to base64 (for mock response)
      const convertImageToBase64 = (file) => {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result.split(',')[1]);
          reader.readAsDataURL(file);
        });
      };

      return (
        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-sm">
          <h1 className="text-2xl font-bold mb-6 text-center text-gray-800">YOLO Object Detection</h1>
          
          {/* Form */}
          <form onSubmit={handleSubmit}>
            <div className="mb-4">
              <label htmlFor="imageInput" className="block text-sm font-medium text-gray-700 mb-2">
                Upload Image
              </label>
              <input
                id="imageInput"
                type="file"
                accept="image/*"
                onChange={handleFileChange}
                className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
              />
            </div>
            
            <button
              type="submit"
              disabled={loading}
              className={`w-full py-2 px-4 rounded text-white font-semibold ${loading ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}`}
            >
              {loading ? 'Processing...' : 'Detect Objects'}
            </button>
          </form>
          
          {/* Result Section */}
          {result && (
            <div className="mt-6">
              <h2 className="text-lg font-semibold mb-2 text-gray-800">Detection Results</h2>
              <canvas ref={canvasRef} className="max-w-full rounded shadow"></canvas>
              <div className="mt-4">
                <h3 className="text-md font-medium text-gray-700">Detected Objects:</h3>
                <ul className="list-disc pl-5 text-gray-600">
                  {result.objects.map((obj, index) => (
                    <li key={index}>
                      {obj.class} - Confidence: {(obj.confidence * 100).toFixed(2)}%
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          )}
          
          {/* Footer */}
          <p className="mt-6 text-center text-gray-500 text-sm">
            Powered by YOLO | Built with React & Tailwind CSS
          </p>
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>